<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rental Database CRUD</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .description {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            background-color: #fff;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 0;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background-color: #ecf0f1;
            border: none;
            outline: none;
            flex-grow: 1;
            text-align: center;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background-color: #d5dbdb;
        }
        
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
            background-color: #fff;
            padding: 25px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-delete {
            background-color: #e74c3c;
        }
        
        .btn-delete:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-logout {
            background-color: #95a5a6;
            float: right;
        }
        
        .btn-logout:hover {
            background-color: #7f8c8d;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .data-table th, .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-table th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
        }
        
        .data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .action-btn {
            padding: 6px 12px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .edit-btn {
            background-color: #f39c12;
            color: white;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .auth-section {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .hidden {
            display: none;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending {
            background-color: #f1c40f;
            color: #000;
        }
        
        .status-ongoing {
            background-color: #3498db;
            color: white;
        }
        
        .status-completed {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-cancelled {
            background-color: #e74c3c;
            color: white;
        }
        
        .status-available {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-rented {
            background-color: #3498db;
            color: white;
        }
        
        .status-maintenance {
            background-color: #f39c12;
            color: white;
        }
        
        .login-message {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
        }
        
        .firebase-config {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Rental Database CRUD Interface</h1>
            <p class="description">A simple interface for managing your rental database with Firebase Firestore</p>
        </header>
        
        <!-- Firebase Configuration Display -->
        <div class="firebase-config">
            <strong>Firebase Configuration Status:</strong> <span id="firebase-status">Not initialized</span>
        </div>
        
        <!-- Authentication Section -->
        <div id="auth-section" class="auth-section">
            <h2>Authentication Required</h2>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <button type="button" class="btn btn-success" id="login-btn">Login</button>
            <button type="button" class="btn" id="register-btn">Register</button>
            <div id="auth-message" style="margin-top: 15px;"></div>
        </div>
        
        <!-- Main Application (hidden until authenticated) -->
        <div id="app-container" class="hidden">
            <div style="text-align: right; margin-bottom: 20px;">
                <button type="button" class="btn btn-logout" id="logout-btn">Logout</button>
            </div>
            
            <!-- Tabs for different entities -->
            <div class="tabs">
                <button type="button" class="tab active" data-tab="users">Users</button>
                <button type="button" class="tab" data-tab="rentals">Rentals</button>
                <button type="button" class="tab" data-tab="rental-items">Rental Items</button>
                <button type="button" class="tab" data-tab="categories">Item Categories</button>
                <button type="button" class="tab" data-tab="rental-details">Rental Details</button>
                <button type="button" class="tab" data-tab="deliveries">Deliveries</button>
                <button type="button" class="tab" data-tab="payments">Payments</button>
            </div>
            
            <!-- Users Tab -->
            <div id="users" class="tab-content active">
                <h2>Users Management</h2>
                <form id="users-form">
                    <input type="hidden" id="user-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="full-name">Full Name</label>
                            <input type="text" id="full-name" required>
                        </div>
                        <div class="form-group">
                            <label for="user-email">Email</label>
                            <input type="email" id="user-email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="role">Role</label>
                            <select id="role" required>
                                <option value="">Select Role</option>
                                <option value="admin">Admin</option>
                                <option value="customer">Customer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="is-active">Status</label>
                            <select id="is-active" required>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success" id="save-user">Save User</button>
                    <button type="button" class="btn" id="clear-user">Clear Form</button>
                </form>
                
                <h3>User List</h3>
                <table class="data-table" id="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-list">
                        <!-- Users will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Rentals Tab -->
            <div id="rentals" class="tab-content">
                <h2>Rentals Management</h2>
                <form id="rentals-form">
                    <input type="hidden" id="rental-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-id-select">User</label>
                            <select id="user-id-select" required>
                                <option value="">Select User</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rental-date">Rental Date</label>
                            <input type="date" id="rental-date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="start-time">Start Time</label>
                            <input type="time" id="start-time" required>
                        </div>
                        <div class="form-group">
                            <label for="total-hours">Total Hours</label>
                            <input type="number" id="total-hours" min="1" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="delivery-fee">Delivery Fee</label>
                            <input type="number" id="delivery-fee" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="total-price">Total Price</label>
                            <input type="number" id="total-price" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="rental-status">Status</label>
                        <select id="rental-status" required>
                            <option value="pending">Pending</option>
                            <option value="ongoing">Ongoing</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-success" id="save-rental">Save Rental</button>
                    <button type="button" class="btn" id="clear-rental">Clear Form</button>
                </form>
                
                <h3>Rental List</h3>
                <table class="data-table" id="rentals-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Date</th>
                            <th>Total Hours</th>
                            <th>Total Price</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rentals-list">
                        <!-- Rentals will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Rental Items Tab -->
            <div id="rental-items" class="tab-content">
                <h2>Rental Items Management</h2>
                <form id="rental-items-form">
                    <input type="hidden" id="item-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="category-id-select">Category</label>
                            <select id="category-id-select" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="item-name">Item Name</label>
                            <input type="text" id="item-name" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="item-description">Description</label>
                        <textarea id="item-description" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hourly-rate">Hourly Rate</label>
                            <input type="number" id="hourly-rate" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="item-status">Status</label>
                            <select id="item-status" required>
                                <option value="available">Available</option>
                                <option value="rented">Rented</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success" id="save-item">Save Item</button>
                    <button type="button" class="btn" id="clear-item">Clear Form</button>
                </form>
                
                <h3>Rental Items List</h3>
                <table class="data-table" id="items-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th>Hourly Rate</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="items-list">
                        <!-- Items will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Categories Tab -->
            <div id="categories" class="tab-content">
                <h2>Item Categories Management</h2>
                <form id="categories-form">
                    <input type="hidden" id="category-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="category-name">Category Name</label>
                            <input type="text" id="category-name" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="category-description">Description</label>
                        <textarea id="category-description" required></textarea>
                    </div>
                    <button type="button" class="btn btn-success" id="save-category">Save Category</button>
                    <button type="button" class="btn" id="clear-category">Clear Form</button>
                </form>
                
                <h3>Categories List</h3>
                <table class="data-table" id="categories-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Category Name</th>
                            <th>Description</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categories-list">
                        <!-- Categories will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Rental Details Tab -->
            <div id="rental-details" class="tab-content">
                <h2>Rental Details Management</h2>
                <form id="rental-details-form">
                    <input type="hidden" id="rental-detail-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="detail-rental-id">Rental</label>
                            <select id="detail-rental-id" required>
                                <option value="">Select Rental</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="detail-item-id">Item</label>
                            <select id="detail-item-id" required>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="detail-hourly-rate">Hourly Rate</label>
                            <input type="number" id="detail-hourly-rate" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="detail-hours">Hours</label>
                            <input type="number" id="detail-hours" min="1" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="detail-subtotal">Subtotal (Auto-calculated)</label>
                        <input type="number" id="detail-subtotal" step="0.01" readonly>
                    </div>
                    <button type="button" class="btn btn-success" id="save-rental-detail">Save Rental Detail</button>
                    <button type="button" class="btn" id="clear-rental-detail">Clear Form</button>
                </form>
                
                <h3>Rental Details List</h3>
                <table class="data-table" id="rental-details-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Rental ID</th>
                            <th>Item Name</th>
                            <th>Hourly Rate</th>
                            <th>Hours</th>
                            <th>Subtotal</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rental-details-list">
                        <!-- Rental details will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Deliveries Tab -->
            <div id="deliveries" class="tab-content">
                <h2>Deliveries Management</h2>
                <form id="deliveries-form">
                    <input type="hidden" id="delivery-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="delivery-rental-id">Rental</label>
                            <select id="delivery-rental-id" required>
                                <option value="">Select Rental</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="delivery-address">Delivery Address</label>
                            <textarea id="delivery-address" required></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="delivery-status">Delivery Status</label>
                        <select id="delivery-status" required>
                            <option value="pending">Pending</option>
                            <option value="delivered">Delivered</option>
                            <option value="returned">Returned</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-success" id="save-delivery">Save Delivery</button>
                    <button type="button" class="btn" id="clear-delivery">Clear Form</button>
                </form>
                
                <h3>Deliveries List</h3>
                <table class="data-table" id="deliveries-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Rental ID</th>
                            <th>Delivery Address</th>
                            <th>Delivery Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="deliveries-list">
                        <!-- Deliveries will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Payments Tab -->
            <div id="payments" class="tab-content">
                <h2>Payments Management</h2>
                <form id="payments-form">
                    <input type="hidden" id="payment-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-rental-id">Rental</label>
                            <select id="payment-rental-id" required>
                                <option value="">Select Rental</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payment-method">Payment Method</label>
                            <select id="payment-method" required>
                                <option value="cash">Cash</option>
                                <option value="gcash">GCash</option>
                                <option value="bank">Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-status">Payment Status</label>
                            <select id="payment-status" required>
                                <option value="paid">Paid</option>
                                <option value="unpaid">Unpaid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="payment-date">Payment Date</label>
                        <input type="date" id="payment-date" required>
                    </div>
                    <button type="button" class="btn btn-success" id="save-payment">Save Payment</button>
                    <button type="button" class="btn" id="clear-payment">Clear Form</button>
                </form>
                
                <h3>Payments List</h3>
                <table class="data-table" id="payments-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Rental ID</th>
                            <th>Payment Method</th>
                            <th>Payment Status</th>
                            <th>Payment Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payments-list">
                        <!-- Payments will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            getDocs,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAJJwpEpsFGgMVIIhsIwWWew0l4H2owAE8",
            authDomain: "certicode-eb81f.firebaseapp.com",
            projectId: "certicode-eb81f",
            storageBucket: "certicode-eb81f.firebasestorage.app",
            messagingSenderId: "314128261163",
            appId: "1:314128261163:web:1c49ea4c01a144656b0a6e"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Update Firebase status
        document.getElementById('firebase-status').textContent = 'Initialized successfully';
        document.getElementById('firebase-status').style.color = '#2ecc71';
        
        // Global data stores
        let usersData = {};
        let rentalsData = {};
        let rentalItemsData = {};
        let categoriesData = {};
        let rentalDetailsData = {};
        let deliveriesData = {};
        let paymentsData = {};
        
        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authMessage = document.getElementById('auth-message');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        
        // Tab functionality
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show active tab content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === tabId) {
                        content.classList.add('active');
                    }
                });
            });
        });
        
        // Authentication functions
        async function registerUser(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Store user data with ID in the document (not as document ID)
                const userData = {
                    id: user.uid, // Store the ID in the document data
                    full_name: email.split('@')[0],
                    email: email,
                    role: "customer",
                    is_active: true,
                    created_at: serverTimestamp(),
                    updated_at: serverTimestamp()
                };
                
                // Store with a generated document ID, not the user.uid
                await addDoc(collection(db, "users"), userData);
                
                showAuthMessage('Registration successful! You can now login.', 'success');
                return user;
            } catch (error) {
                showAuthMessage(`Registration error: ${error.message}`, 'error');
                console.error("Registration error:", error);
                return null;
            }
        }
        
        async function loginUser(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                showAuthMessage('Login successful!', 'success');
                return userCredential.user;
            } catch (error) {
                showAuthMessage(`Login error: ${error.message}`, 'error');
                console.error("Login error:", error);
                return null;
            }
        }
        
        async function logoutUser() {
            try {
                await signOut(auth);
                showAuthMessage('Logged out successfully!', 'success');
                return true;
            } catch (error) {
                console.error("Logout error:", error);
                return false;
            }
        }
        
        function showAuthMessage(message, type) {
            authMessage.textContent = message;
            authMessage.style.color = type === 'success' ? '#2ecc71' : '#e74c3c';
            authMessage.style.fontWeight = '600';
        }
        
        // Populate dropdowns
        async function populateUserDropdown() {
            const userSelect = document.getElementById('user-id-select');
            const detailRentalSelect = document.getElementById('detail-rental-id');
            const deliveryRentalSelect = document.getElementById('delivery-rental-id');
            const paymentRentalSelect = document.getElementById('payment-rental-id');
            
            // Clear existing options except the first one
            [userSelect, detailRentalSelect, deliveryRentalSelect, paymentRentalSelect].forEach(select => {
                if (select) {
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                }
            });
            
            // Add users to user dropdown
            Object.values(usersData).forEach(user => {
                if (user.is_active) {
                    const option = document.createElement('option');
                    option.value = user.docId; // Use document ID as value
                    option.textContent = `${user.full_name} (${user.email})`;
                    if (userSelect) userSelect.appendChild(option.cloneNode(true));
                }
            });
            
            // Add rentals to rental dropdowns
            Object.values(rentalsData).forEach(rental => {
                const user = usersData[rental.user_id];
                const userName = user ? user.full_name : 'Unknown User';
                
                const option = document.createElement('option');
                option.value = rental.docId;
                option.textContent = `Rental: ${rental.docId.substring(0, 8)}... - ${userName}`;
                
                if (detailRentalSelect) detailRentalSelect.appendChild(option.cloneNode(true));
                if (deliveryRentalSelect) deliveryRentalSelect.appendChild(option.cloneNode(true));
                if (paymentRentalSelect) paymentRentalSelect.appendChild(option.cloneNode(true));
            });
        }
        
        async function populateCategoryDropdown() {
            const categorySelect = document.getElementById('category-id-select');
            const itemSelect = document.getElementById('detail-item-id');
            
            // Clear existing options except the first one
            [categorySelect, itemSelect].forEach(select => {
                if (select) {
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                }
            });
            
            // Add categories to category dropdown
            Object.values(categoriesData).forEach(category => {
                const option = document.createElement('option');
                option.value = category.docId;
                option.textContent = category.category_name;
                if (categorySelect) categorySelect.appendChild(option.cloneNode(true));
            });
            
            // Add items to item dropdown
            Object.values(rentalItemsData).forEach(item => {
                const option = document.createElement('option');
                option.value = item.docId;
                option.textContent = item.item_name;
                if (itemSelect) itemSelect.appendChild(option.cloneNode(true));
            });
        }
        
        // CRUD Functions for Users
        async function loadUsers() {
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                usersData = {};
                const usersList = document.getElementById('users-list');
                if (usersList) usersList.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const user = {
                        docId: doc.id, // Store document ID
                        ...doc.data()
                    };
                    usersData[doc.id] = user;
                    
                    if (usersList) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.id || doc.id.substring(0, 8)}...</td>
                            <td>${user.full_name || 'N/A'}</td>
                            <td>${user.email || 'N/A'}</td>
                            <td>${user.role || 'N/A'}</td>
                            <td><span class="status-badge ${user.is_active ? 'status-available' : 'status-cancelled'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>${user.created_at ? new Date(user.created_at.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <button class="action-btn edit-btn" onclick="editUser('${doc.id}')">Edit</button>
                                <button class="action-btn delete-btn" onclick="deleteUser('${doc.id}')">Delete</button>
                            </td>
                        `;
                        usersList.appendChild(row);
                    }
                });
                
                // Populate dropdowns after loading users
                await populateUserDropdown();
            } catch (error) {
                console.error("Error loading users:", error);
            }
        }
        
        // Edit user function
        window.editUser = async function(docId) {
            try {
                const user = usersData[docId];
                if (!user) return;
                
                document.getElementById('user-id').value = docId;
                document.getElementById('full-name').value = user.full_name || '';
                document.getElementById('user-email').value = user.email || '';
                document.getElementById('role').value = user.role || 'customer';
                document.getElementById('is-active').value = user.is_active ? 'true' : 'false';
                
                // Scroll to form
                document.getElementById('users-form').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error("Error editing user:", error);
                alert('Error loading user data: ' + error.message);
            }
        };
        
        // Delete user function
        window.deleteUser = async function(docId) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    await deleteDoc(doc(db, "users", docId));
                    await loadUsers();
                } catch (error) {
                    console.error("Error deleting user:", error);
                    alert('Error deleting user: ' + error.message);
                }
            }
        };
        
        // Add/Update user
        document.getElementById('save-user').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const docId = document.getElementById('user-id').value;
            const fullName = document.getElementById('full-name').value;
            const userEmail = document.getElementById('user-email').value;
            const role = document.getElementById('role').value;
            const isActive = document.getElementById('is-active').value === 'true';
            
            try {
                const userData = {
                    full_name: fullName,
                    email: userEmail,
                    role: role,
                    is_active: isActive,
                    updated_at: serverTimestamp()
                };
                
                if (docId) {
                    // Update existing user
                    const userRef = doc(db, "users", docId);
                    await updateDoc(userRef, userData);
                } else {
                    // Add new user
                    userData.created_at = serverTimestamp();
                    await addDoc(collection(db, "users"), userData);
                }
                
                // Clear form and reload data
                document.getElementById('users-form').reset();
                document.getElementById('user-id').value = '';
                await loadUsers();
            } catch (error) {
                console.error("Error saving user:", error);
                alert('Error saving user: ' + error.message);
            }
        });
        
        // Clear user form
        document.getElementById('clear-user').addEventListener('click', () => {
            document.getElementById('users-form').reset();
            document.getElementById('user-id').value = '';
        });
        
        // CRUD Functions for Rentals
        async function loadRentals() {
            try {
                const querySnapshot = await getDocs(collection(db, "rentals"));
                rentalsData = {};
                const rentalsList = document.getElementById('rentals-list');
                if (rentalsList) rentalsList.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const rental = {
                        docId: doc.id,
                        ...doc.data()
                    };
                    rentalsData[doc.id] = rental;
                    
                    if (rentalsList) {
                        const user = usersData[rental.user_id];
                        const userName = user ? user.full_name : 'Unknown';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${rental.id || doc.id.substring(0, 8)}...</td>
                            <td>${userName}</td>
                            <td>${rental.rental_date || 'N/A'}</td>
                            <td>${rental.total_hours || 'N/A'}</td>
                            <td>${rental.total_price ? '$' + rental.total_price.toFixed(2) : 'N/A'}</td>
                            <td><span class="status-badge status-${rental.status || 'pending'}">${rental.status || 'Pending'}</span></td>
                            <td>${rental.created_at ? new Date(rental.created_at.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <button class="action-btn edit-btn" onclick="editRental('${doc.id}')">Edit</button>
                                <button class="action-btn delete-btn" onclick="deleteRental('${doc.id}')">Delete</button>
                            </td>
                        `;
                        rentalsList.appendChild(row);
                    }
                });
                
                // Populate dropdowns
                await populateUserDropdown();
            } catch (error) {
                console.error("Error loading rentals:", error);
            }
        }
        
        // Edit rental function
        window.editRental = async function(docId) {
            try {
                const rental = rentalsData[docId];
                if (!rental) return;
                
                document.getElementById('rental-id').value = docId;
                document.getElementById('user-id-select').value = rental.user_id || '';
                document.getElementById('rental-date').value = rental.rental_date || '';
                document.getElementById('start-time').value = rental.start_time || '';
                document.getElementById('total-hours').value = rental.total_hours || 1;
                document.getElementById('delivery-fee').value = rental.delivery_fee || 0;
                document.getElementById('total-price').value = rental.total_price || 0;
                document.getElementById('rental-status').value = rental.status || 'pending';
                
                // Scroll to form
                document.getElementById('rentals-form').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error("Error editing rental:", error);
                alert('Error loading rental data: ' + error.message);
            }
        };
        
        // Delete rental function
        window.deleteRental = async function(docId) {
            if (confirm('Are you sure you want to delete this rental?')) {
                try {
                    await deleteDoc(doc(db, "rentals", docId));
                    await loadRentals();
                } catch (error) {
                    console.error("Error deleting rental:", error);
                    alert('Error deleting rental: ' + error.message);
                }
            }
        };
        
        // Add/Update rental
        document.getElementById('save-rental').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const docId = document.getElementById('rental-id').value;
            const userId = document.getElementById('user-id-select').value;
            const rentalDate = document.getElementById('rental-date').value;
            const startTime = document.getElementById('start-time').value;
            const totalHours = parseInt(document.getElementById('total-hours').value);
            const deliveryFee = parseFloat(document.getElementById('delivery-fee').value);
            const totalPrice = parseFloat(document.getElementById('total-price').value);
            const status = document.getElementById('rental-status').value;
            
            try {
                const rentalData = {
                    user_id: userId,
                    rental_date: rentalDate,
                    start_time: startTime,
                    total_hours: totalHours,
                    delivery_fee: deliveryFee,
                    total_price: totalPrice,
                    status: status
                };
                
                if (docId) {
                    // Update existing rental
                    const rentalRef = doc(db, "rentals", docId);
                    await updateDoc(rentalRef, rentalData);
                } else {
                    // Add new rental
                    rentalData.created_at = serverTimestamp();
                    await addDoc(collection(db, "rentals"), rentalData);
                }
                
                // Clear form and reload data
                document.getElementById('rentals-form').reset();
                document.getElementById('rental-id').value = '';
                await loadRentals();
            } catch (error) {
                console.error("Error saving rental:", error);
                alert('Error saving rental: ' + error.message);
            }
        });
        
        // Clear rental form
        document.getElementById('clear-rental').addEventListener('click', () => {
            document.getElementById('rentals-form').reset();
            document.getElementById('rental-id').value = '';
        });
        
        // CRUD Functions for Categories
        async function loadCategories() {
            try {
                const querySnapshot = await getDocs(collection(db, "item_categories"));
                categoriesData = {};
                const categoriesList = document.getElementById('categories-list');
                if (categoriesList) categoriesList.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const category = {
                        docId: doc.id,
                        ...doc.data()
                    };
                    categoriesData[doc.id] = category;
                    
                    if (categoriesList) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${category.id || doc.id.substring(0, 8)}...</td>
                            <td>${category.category_name || 'N/A'}</td>
                            <td>${category.description || 'N/A'}</td>
                            <td>${category.created_at ? new Date(category.created_at.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <button class="action-btn edit-btn" onclick="editCategory('${doc.id}')">Edit</button>
                                <button class="action-btn delete-btn" onclick="deleteCategory('${doc.id}')">Delete</button>
                            </td>
                        `;
                        categoriesList.appendChild(row);
                    }
                });
                
                // Populate dropdowns
                await populateCategoryDropdown();
            } catch (error) {
                console.error("Error loading categories:", error);
            }
        }
        
        // Edit category function
        window.editCategory = async function(docId) {
            try {
                const category = categoriesData[docId];
                if (!category) return;
                
                document.getElementById('category-id').value = docId;
                document.getElementById('category-name').value = category.category_name || '';
                document.getElementById('category-description').value = category.description || '';
                
                // Scroll to form
                document.getElementById('categories-form').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error("Error editing category:", error);
                alert('Error loading category data: ' + error.message);
            }
        };
        
        // Delete category function
        window.deleteCategory = async function(docId) {
            if (confirm('Are you sure you want to delete this category?')) {
                try {
                    await deleteDoc(doc(db, "item_categories", docId));
                    await loadCategories();
                } catch (error) {
                    console.error("Error deleting category:", error);
                    alert('Error deleting category: ' + error.message);
                }
            }
        };
        
        // Add/Update category
        document.getElementById('save-category').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const docId = document.getElementById('category-id').value;
            const categoryName = document.getElementById('category-name').value;
            const description = document.getElementById('category-description').value;
            
            try {
                const categoryData = {
                    category_name: categoryName,
                    description: description
                };
                
                if (docId) {
                    // Update existing category
                    const categoryRef = doc(db, "item_categories", docId);
                    await updateDoc(categoryRef, categoryData);
                } else {
                    // Add new category
                    categoryData.created_at = serverTimestamp();
                    await addDoc(collection(db, "item_categories"), categoryData);
                }
                
                // Clear form and reload data
                document.getElementById('categories-form').reset();
                document.getElementById('category-id').value = '';
                await loadCategories();
            } catch (error) {
                console.error("Error saving category:", error);
                alert('Error saving category: ' + error.message);
            }
        });
        
        // Clear category form
        document.getElementById('clear-category').addEventListener('click', () => {
            document.getElementById('categories-form').reset();
            document.getElementById('category-id').value = '';
        });
        
        // CRUD Functions for Rental Items
        async function loadRentalItems() {
            try {
                const querySnapshot = await getDocs(collection(db, "rental_items"));
                rentalItemsData = {};
                const itemsList = document.getElementById('items-list');
                if (itemsList) itemsList.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const item = {
                        docId: doc.id,
                        ...doc.data()
                    };
                    rentalItemsData[doc.id] = item;
                    
                    if (itemsList) {
                        const category = categoriesData[item.category_id];
                        const categoryName = category ? category.category_name : 'Unknown';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.id || doc.id.substring(0, 8)}...</td>
                            <td>${item.item_name || 'N/A'}</td>
                            <td>${categoryName}</td>
                            <td>${item.hourly_rate ? '$' + item.hourly_rate.toFixed(2) + '/hr' : 'N/A'}</td>
                            <td><span class="status-badge status-${item.status || 'available'}">${item.status || 'Available'}</span></td>
                            <td>${item.created_at ? new Date(item.created_at.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <button class="action-btn edit-btn" onclick="editItem('${doc.id}')">Edit</button>
                                <button class="action-btn delete-btn" onclick="deleteItem('${doc.id}')">Delete</button>
                            </td>
                        `;
                        itemsList.appendChild(row);
                    }
                });
                
                // Populate dropdowns
                await populateCategoryDropdown();
            } catch (error) {
                console.error("Error loading rental items:", error);
            }
        }
        
        // Edit item function
        window.editItem = async function(docId) {
            try {
                const item = rentalItemsData[docId];
                if (!item) return;
                
                document.getElementById('item-id').value = docId;
                document.getElementById('category-id-select').value = item.category_id || '';
                document.getElementById('item-name').value = item.item_name || '';
                document.getElementById('item-description').value = item.description || '';
                document.getElementById('hourly-rate').value = item.hourly_rate || 0;
                document.getElementById('item-status').value = item.status || 'available';
                
                // Scroll to form
                document.getElementById('rental-items-form').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error("Error editing item:", error);
                alert('Error loading item data: ' + error.message);
            }
        };
        
        // Delete item function
        window.deleteItem = async function(docId) {
            if (confirm('Are you sure you want to delete this item?')) {
                try {
                    await deleteDoc(doc(db, "rental_items", docId));
                    await loadRentalItems();
                } catch (error) {
                    console.error("Error deleting item:", error);
                    alert('Error deleting item: ' + error.message);
                }
            }
        };
        
        // Add/Update item
        document.getElementById('save-item').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const docId = document.getElementById('item-id').value;
            const categoryId = document.getElementById('category-id-select').value;
            const itemName = document.getElementById('item-name').value;
            const description = document.getElementById('item-description').value;
            const hourlyRate = parseFloat(document.getElementById('hourly-rate').value);
            const status = document.getElementById('item-status').value;
            
            try {
                const itemData = {
                    category_id: categoryId,
                    item_name: itemName,
                    description: description,
                    hourly_rate: hourlyRate,
                    status: status,
                    updated_at: serverTimestamp()
                };
                
                if (docId) {
                    // Update existing item
                    const itemRef = doc(db, "rental_items", docId);
                    await updateDoc(itemRef, itemData);
                } else {
                    // Add new item
                    itemData.created_at = serverTimestamp();
                    await addDoc(collection(db, "rental_items"), itemData);
                }
                
                // Clear form and reload data
                document.getElementById('rental-items-form').reset();
                document.getElementById('item-id').value = '';
                await loadRentalItems();
            } catch (error) {
                console.error("Error saving rental item:", error);
                alert('Error saving rental item: ' + error.message);
            }
        });
        
        // Clear item form
        document.getElementById('clear-item').addEventListener('click', () => {
            document.getElementById('rental-items-form').reset();
            document.getElementById('item-id').value = '';
        });
        
        // CRUD Functions for Rental Details
        async function loadRentalDetails() {
            try {
                const querySnapshot = await getDocs(collection(db, "rental_details"));
                rentalDetailsData = {};
                const rentalDetailsList = document.getElementById('rental-details-list');
                if (rentalDetailsList) rentalDetailsList.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const detail = {
                        docId: doc.id,
                        ...doc.data()
                    };
                    rentalDetailsData[doc.id] = detail;
                    
                    if (rentalDetailsList) {
                        const item = rentalItemsData[detail.item_id];
                        const itemName = item ? item.item_name : 'Unknown Item';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${detail.id || doc.id.substring(0, 8)}...</td>
                            <td>${detail.rental_id ? detail.rental_id.substring(0, 8) + '...' : 'N/A'}</td>
                            <td>${itemName}</td>
                            <td>${detail.hourly_rate ? '$' + detail.hourly_rate.toFixed(2) : 'N/A'}</td>
                            <td>${detail.hours || 'N/A'}</td>
                            <td>${detail.subtotal ? '$' + detail.subtotal.toFixed(2) : 'N/A'}</td>
                            <td>
                                <button class="action-btn edit-btn" onclick="editRentalDetail('${doc.id}')">Edit</button>
                                <button class="action-btn delete-btn" onclick="deleteRentalDetail('${doc.id}')">Delete</button>
                            </td>
                        `;
                        rentalDetailsList.appendChild(row);
                    }
                });
                
                // Populate dropdowns
                await populateUserDropdown();
                await populateCategoryDropdown();
            } catch (error) {
                console.error("Error loading rental details:", error);
            }
        }
        
        // Initialize subtotal calculation
        document.getElementById('detail-hourly-rate')?.addEventListener('input', calculateSubtotal);
        document.getElementById('detail-hours')?.addEventListener('input', calculateSubtotal);
        
        function calculateSubtotal() {
            const hourlyRate = parseFloat(document.getElementById('detail-hourly-rate').value) || 0;
            const hours = parseInt(document.getElementById('detail-hours').value) || 0;
            const subtotal = hourlyRate * hours;
            document.getElementById('detail-subtotal').value = subtotal.toFixed(2);
        }
        
        // Edit rental detail function
        window.editRentalDetail = async function(docId) {
            try {
                const detail = rentalDetailsData[docId];
                if (!detail) return;
                
                document.getElementById('rental-detail-id').value = docId;
                document.getElementById('detail-rental-id').value = detail.rental_id || '';
                document.getElementById('detail-item-id').value = detail.item_id || '';
                document.getElementById('detail-hourly-rate').value = detail.hourly_rate || 0;
                document.getElementById('detail-hours').value = detail.hours || 1;
                calculateSubtotal();
                
                // Scroll to form
                document.getElementById('rental-details-form').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error("Error editing rental detail:", error);
                alert('Error loading rental detail data: ' + error.message);
            }
        };
        
        // Delete rental detail function
        window.deleteRentalDetail = async function(docId) {
            if (confirm('Are you sure you want to delete this rental detail?')) {
                try {
                    await deleteDoc(doc(db, "rental_details", docId));
                    await loadRentalDetails();
                } catch (error) {
                    console.error("Error deleting rental detail:", error);
                    alert('Error deleting rental detail: ' + error.message);
                }
            }
        };
        
        // Add/Update rental detail
        document.getElementById('save-rental-detail')?.addEventListener('click', async (e) => {
            e.preventDefault();
            
            const docId = document.getElementById('rental-detail-id').value;
            const rentalId = document.getElementById('detail-rental-id').value;
            const itemId = document.getElementById('detail-item-id').value;
            const hourlyRate = parseFloat(document.getElementById('detail-hourly-rate').value);
            const hours = parseInt(document.getElementById('detail-hours').value);
            const subtotal = parseFloat(document.getElementById('detail-subtotal').value);
            
            try {
                const detailData = {
                    rental_id: rentalId,
                    item_id: itemId,
                    hourly_rate: hourlyRate,
                    hours: hours,
                    subtotal: subtotal
                };
                
                if (docId) {
                    // Update existing rental detail
                    const detailRef = doc(db, "rental_details", docId);
                    await updateDoc(detailRef, detailData);
                } else {
                    // Add new rental detail
                    await addDoc(collection(db, "rental_details"), detailData);
                }
                
                // Clear form and reload data
                document.getElementById('rental-details-form').reset();
                document.getElementById('rental-detail-id').value = '';
                document.getElementById('detail-subtotal').value = '';
                await loadRentalDetails();
            } catch (error) {
                console.error("Error saving rental detail:", error);
                alert('Error saving rental detail: ' + error.message);
            }
        });
        
        // Clear rental detail form
        document.getElementById('clear-rental-detail')?.addEventListener('click', () => {
            document.getElementById('rental-details-form').reset();
            document.getElementById('rental-detail-id').value = '';
            document.getElementById('detail-subtotal').value = '';
        });
        
        // CRUD Functions for Deliveries
        async function loadDeliveries() {
            try {
                const querySnapshot = await getDocs(collection(db, "deliveries"));
                deliveriesData = {};
                const deliveriesList = document.getElementById('deliveries-list');
                if (deliveriesList) deliveriesList.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const delivery = {
                        docId: doc.id,
                        ...doc.data()
                    };
                    deliveriesData[doc.id] = delivery;
                    
                    if (deliveriesList) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${delivery.id || doc.id.substring(0, 8)}...</td>
                            <td>${delivery.rental_id ? delivery.rental_id.substring(0, 8) + '...' : 'N/A'}</td>
                            <td>${delivery.delivery_address || 'N/A'}</td>
                            <td><span class="status-badge status-${delivery.delivery_status || 'pending'}">${delivery.delivery_status || 'Pending'}</span></td>
                            <td>
                                <button class="action-btn edit-btn" onclick="editDelivery('${doc.id}')">Edit</button>
                                <button class="action-btn delete-btn" onclick="deleteDelivery('${doc.id}')">Delete</button>
                            </td>
                        `;
                        deliveriesList.appendChild(row);
                    }
                });
            } catch (error) {
                console.error("Error loading deliveries:", error);
            }
        }
        
        // Add/Update delivery
        document.getElementById('save-delivery')?.addEventListener('click', async (e) => {
            e.preventDefault();
            
            const docId = document.getElementById('delivery-id').value;
            const rentalId = document.getElementById('delivery-rental-id').value;
            const deliveryAddress = document.getElementById('delivery-address').value;
            const deliveryStatus = document.getElementById('delivery-status').value;
            
            try {
                const deliveryData = {
                    rental_id: rentalId,
                    delivery_address: deliveryAddress,
                    delivery_status: deliveryStatus
                };
                
                if (docId) {
                    // Update existing delivery
                    const deliveryRef = doc(db, "deliveries", docId);
                    await updateDoc(deliveryRef, deliveryData);
                } else {
                    // Add new delivery
                    await addDoc(collection(db, "deliveries"), deliveryData);
                }
                
                // Clear form and reload data
                document.getElementById('deliveries-form').reset();
                document.getElementById('delivery-id').value = '';
                await loadDeliveries();
            } catch (error) {
                console.error("Error saving delivery:", error);
                alert('Error saving delivery: ' + error.message);
            }
        });
        
        // CRUD Functions for Payments
        async function loadPayments() {
            try {
                const querySnapshot = await getDocs(collection(db, "payments"));
                paymentsData = {};
                const paymentsList = document.getElementById('payments-list');
                if (paymentsList) paymentsList.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const payment = {
                        docId: doc.id,
                        ...doc.data()
                    };
                    paymentsData[doc.id] = payment;
                    
                    if (paymentsList) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${payment.id || doc.id.substring(0, 8)}...</td>
                            <td>${payment.rental_id ? payment.rental_id.substring(0, 8) + '...' : 'N/A'}</td>
                            <td>${payment.payment_method || 'N/A'}</td>
                            <td><span class="status-badge ${payment.payment_status === 'paid' ? 'status-completed' : 'status-pending'}">${payment.payment_status || 'Unpaid'}</span></td>
                            <td>${payment.payment_date || 'N/A'}</td>
                            <td>
                                <button class="action-btn edit-btn" onclick="editPayment('${doc.id}')">Edit</button>
                                <button class="action-btn delete-btn" onclick="deletePayment('${doc.id}')">Delete</button>
                            </td>
                        `;
                        paymentsList.appendChild(row);
                    }
                });
            } catch (error) {
                console.error("Error loading payments:", error);
            }
        }
        
        // Add/Update payment
        document.getElementById('save-payment')?.addEventListener('click', async (e) => {
            e.preventDefault();
            
            const docId = document.getElementById('payment-id').value;
            const rentalId = document.getElementById('payment-rental-id').value;
            const paymentMethod = document.getElementById('payment-method').value;
            const paymentStatus = document.getElementById('payment-status').value;
            const paymentDate = document.getElementById('payment-date').value;
            
            try {
                const paymentData = {
                    rental_id: rentalId,
                    payment_method: paymentMethod,
                    payment_status: paymentStatus,
                    payment_date: paymentDate
                };
                
                if (docId) {
                    // Update existing payment
                    const paymentRef = doc(db, "payments", docId);
                    await updateDoc(paymentRef, paymentData);
                } else {
                    // Add new payment
                    await addDoc(collection(db, "payments"), paymentData);
                }
                
                // Clear form and reload data
                document.getElementById('payments-form').reset();
                document.getElementById('payment-id').value = '';
                await loadPayments();
            } catch (error) {
                console.error("Error saving payment:", error);
                alert('Error saving payment: ' + error.message);
            }
        });
        
        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                authSection.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Load all data
                await loadUsers();
                await loadCategories();
                await loadRentalItems();
                await loadRentals();
                await loadRentalDetails();
                await loadDeliveries();
                await loadPayments();
            } else {
                // User is signed out
                authSection.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });
        
        // Event Listeners for Authentication
        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                showAuthMessage('Please enter both email and password', 'error');
                return;
            }
            
            await loginUser(email, password);
        });
        
        registerBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                showAuthMessage('Please enter both email and password', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthMessage('Password should be at least 6 characters', 'error');
                return;
            }
            
            await registerUser(email, password);
        });
        
        logoutBtn.addEventListener('click', async () => {
            await logoutUser();
        });
        
        // Set default dates
        window.addEventListener('load', () => {
            // Set today's date as default for rental date
            const today = new Date().toISOString().split('T')[0];
            const rentalDate = document.getElementById('rental-date');
            const paymentDate = document.getElementById('payment-date');
            
            if (rentalDate) rentalDate.value = today;
            if (paymentDate) paymentDate.value = today;
            
            // Set current time as default for start time (rounded to nearest hour)
            const startTime = document.getElementById('start-time');
            if (startTime) {
                const now = new Date();
                now.setMinutes(0);
                const currentTime = now.toTimeString().split(' ')[0].substring(0, 5);
                startTime.value = currentTime;
            }
        });
        
        // Initialize subtotal calculation on page load
        if (document.getElementById('detail-hourly-rate') && document.getElementById('detail-hours')) {
            calculateSubtotal();
        }
        
    </script>
</body>
</html>